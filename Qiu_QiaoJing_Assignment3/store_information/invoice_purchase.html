<script>
  // To get client's order data
  // Reference Lab 12 - Professor Daniel Port
  let params = (new URL(document.location)).searchParams;
</script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Courier+New">
    <title>Document</title>
</head>
<body>
    <script src="products.js">
        //get product information
    </script>
    <script src="./functions.js"></script>
    <script>
        var shopping_cart;
        loadJSON('get_cart', function (response) {
            // Parsing JSON string into object
            shopping_cart = JSON.parse(response);
        });
    </script>

<table border="5" style="margin-left:auto; margin-right:auto;">
    <tbody>
      <tr>
        <th style="text-align: center;" width="30%">Order Information</th>
        <th style="text-align: center;" width="10%">Quantity</th>
        <th style="text-align: center;" width="10%">Unit Price</th>
        <th style="text-align: center;" width="15%">Extended Price</th>
      </tr>
    
    <script>
    // Check client's input, make sure the final input should be a positive integer
    // Check input number if it is an positive integet
    // Reference - Check Positive Integet: Lab 11 - Professor Daniel Port
    function isNonNegInt(q,returnErrors=false) {
        if(q =='') q=0; // Client should not receive any error message if there is no input in the textbox
        var errors = []; // assume no errors at first
        if(Number(q) != q) errors.push('Not a number!'); // Check if string is a number value
        if(q < 0) errors.push('Negative value!'); // Check if it is non-negative
        if(parseInt(q) != q) errors.push('Not an integer!'); // Check that it is an integer
        return returnErrors ? errors : (errors.length == 0); // If there is no error message in the array, the length should be 0, which returns back to true, the input is a positive integer
    };

    // Check client inputted tax year if it is a positive integer and matches with the updated restriction
    function isValidYear (y,returnErrors=false) {
        var errors = [];
        if(y =='')  errors.push('Please enter your desired tax year!');
        if(Number(y) != y) errors.push('Your tax year is not a number!'); 
        if(y < 0) errors.push('Please do not enter a negative number in the tax year box!'); 
        if(parseInt(y) != y) errors.push('Please enter an integer in the tax year box!'); 
        return returnErrors ? errors : (errors.length == 0); 
    }
    
    // set beginning subtotal to be 0
      subtotal = 0;
    // automative adding row function - for tax preparation
    // Reference Lab 12 - Professor Daniel Port
      if (typeof shopping_cart['tax_service'] != 'undefined') {
      for (i=0; i < tax_service.length; i++) {
        if (shopping_cart['tax_service']['quantity'][i]==0) continue; // Skip product with 0 quantity
        else { // Output product information only when the input is a valid number
        extended_price_tax = tax_service[i].price * shopping_cart['tax_service']['quantity'][i]; // Calculate extended price
        subtotal += extended_price_tax; // Create a running subtotal
        document.write(`  
      <tr>
        <td width="33%">Tax Service: ${tax_service[i].name} <br> ${shopping_cart['tax_service']['tax_year'][i]}</td>
        <td align="center" width="10%">${shopping_cart['tax_service']['quantity'][i]}</td>
        <td align="center" width="10%">$${tax_service[i].price.toFixed(2)}</td>
        <td align="center" width="15%">$${extended_price_tax.toFixed(2)}</td>
      </tr>
              `); 
            }
      }
    }
  

    // automative adding row function - for CPA exam preparation
    // Reference Lab 12 - Professor Daniel Port
      if (typeof shopping_cart['CPAexamreview'] != 'undefined') {
      for (i=0; i < CPAexamreview.length; i++) {
        if (shopping_cart['CPAexamreview']['quantity'][i]==0) continue; // Skip product with 0 quantity
          else {
          extended_price_cpa = CPAexamreview[i].price * shopping_cart['CPAexamreview']['quantity'][i]; // Calculate extended price
          subtotal += extended_price_cpa; // Create a running subtotal
        document.write(`  
      <tr>
        <td width="33%">CPA Exam Review: ${CPAexamreview[i].name}</td>
        <td align="center" width="10%">${shopping_cart['CPAexamreview']['quantity'][i]}</td>
        <td align="center" width="10%">$${CPAexamreview[i].price.toFixed(2)}</td>
        <td align="center" width="15%">$${extended_price_cpa.toFixed(2)}</td>
      </tr>
              `); 
            }
      }
    }
  
      if (typeof shopping_cart['tutorial'] != 'undefined') {
      for (i=0; i < tutorial.length; i++) {
        if (shopping_cart['tutorial']['quantity'][i]==0) continue; // Skip product with 0 quantity
        else {
        extended_price_tutorial = tutorial[i].price * shopping_cart['tutorial']['quantity'][i]; // Calculate extended price
        subtotal += extended_price_tutorial; // Create a running subtotal
        document.write(`  
      <tr>
        <td width="33%">Tutorial: ${tutorial[i].name}</td>
        <td align="center" width="10%">${shopping_cart['tutorial']['quantity'][i]}</td>
        <td align="center" width="10%">$${tutorial[i].price.toFixed(2)}</td>
        <td align="center" width="15%">$${extended_price_tutorial.toFixed(2)}</td>
      </tr>
              `); 
            }
      }
    }
  
      if (typeof shopping_cart['consultant'] != 'undefined') {
      for (i=0; i < consultant.length; i++) {
        if (shopping_cart['consultant']['quantity'][i]==0) continue; // Skip product with 0 quantity
        else {
        extended_price_consultant = consultant[i].price * shopping_cart['consultant']['quantity'][i]; // Calculate extended price
        subtotal += extended_price_consultant; // Create a running subtotal
        document.write(`  
      <tr>
        <td width="33%">Consultant: ${consultant[i].name}</td>
        <td align="center" width="10%">${shopping_cart['consultant']['quantity'][i]}</td>
        <td align="center" width="10%">$${consultant[i].price.toFixed(2)}</td>
        <td align="center" width="15%">$${extended_price_consultant.toFixed(2)}</td>
      </tr>
              `); 
            }
      }
    }
    
      // Compute shipping
      var shipping = 0;
      if (subtotal<=100) {
        shipping = 5
      } else if (subtotal<=1000) {
        shipping = 20
      } else {
        shipping = 30
      }

      // Compute tax
      // Reference Invoice 2 - Professor Daniel Port
      var tax_rate = 0.045;
          var tax = subtotal * tax_rate;

      // Compute grand total
      // Reference Invoice 2 - Professor Daniel Port
          var total = tax + subtotal + shipping;

    </script> 

      <tr>
        <td colspan="6" width="100%">&nbsp;</td>
      </tr>


     <script>
       // write subtotal amount
       // Reference Invoice 2 - Professor Daniel Port
    document.write(`
      <tr>
        <td style="text-align: center;" colspan="3" width="50%">Sub total</td>
        <td colspan="3"align="center" width="50%">$${subtotal.toFixed(2)}</td>
      </tr>
     `); 
    </script> 
    <script> 
      // write tax amount
      // Reference Invoice 2 - Professor Daniel Port
    document.write(`
      <tr>
        <td style="text-align: center;" colspan="3" width="67%"><span>Tax @ ${100*tax_rate}%</span></td>
        <td colspan="3"align="center" width="54%">$${tax.toFixed(2)}</td>
      </tr>
    `);  
    </script>

    <script>
      // write shipping fee
      // Reference Invoice 2 - Professor Daniel Port
      document.write(`
        <tr>
          <td style="text-align: center;" colspan="3" width="50%">Shipping Fee</td>
          <td colspan="3"align="center" width="50%">$${shipping.toFixed(2)}</td>
        </tr>
        `); 
    </script> 

    <script>
      // write total charge
      // Reference Invoice 2 - Professor Daniel Port
    document.write(`
      <tr>
        <td style="text-align: center;" colspan="3" width="67%"><strong>Total</strong></td>
        <td colspan="3"align="center" width="54%"><strong>$${total.toFixed(2)}</strong></td>
      </tr>
    `);
    </script>
    </tbody>
  </table>
  <script>
    let firstpart = document.cookie.split('=')
    let uname = firstpart[firstpart.length - 1];
    // show client's user name and purchase information
    document.write(`<p>Aloha, ${uname}! <br>Thank you for selecting our company, this is your invoice. <br>Your order is:</p>`)
  </script>
  <ul>
  <script>
    // skip any 0 quantity item - Tax Preparation
    if (typeof shopping_cart['tax_service'] != 'undefined') {
    for (i=0; i<tax_service.length; i++) {
      if (shopping_cart['tax_service']['quantity'][i] == 0) continue;
      document.write(`
      <li>${shopping_cart['tax_service']['tax_year'][i]}: ${shopping_cart['tax_service']['quantity'][i]} - ${tax_service[i].name}</li>
      `)
    }
  }
      // skip any 0 quantity item - CPA Exam
    if (typeof shopping_cart['CPAexamreview'] != 'undefined') {
    for (i=0; i<CPAexamreview.length; i++) {
    if (shopping_cart['CPAexamreview']['quantity'][i] == 0) continue;
    document.write(`
    <li>CPA Exam Review: ${shopping_cart['CPAexamreview']['quantity'][i]} - ${CPAexamreview[i].name}</li>
    `)
  }
}
      // skip any 0 quantity item - Tutorial
    if (typeof shopping_cart['tutorial'] != 'undefined') {
    for (i=0; i<tutorial.length; i++) {
    if (shopping_cart['tutorial']['quantity'][i] == 0) continue;
    document.write(`
    <li>Tutorial: ${shopping_cart['tutorial']['quantity'][i]} - ${tutorial[i].name}</li>
    `)
  }
}
      // skip any 0 quantity item - Consultant
    if (typeof shopping_cart['consultant'] != 'undefined') {
    for (i=0; i<consultant.length; i++) {
    if (shopping_cart['consultant']['quantity'][i] == 0) continue;
    document.write(`
    <li>Consultant Service: ${shopping_cart['consultant']['quantity'][i]} - ${consultant[i].name}</li>
    `)
  }
}
  </script>
  </ul>

  <p>If your have any question, please call us at (808)-123-4567. </p>
<style>
    th {
        font-size: 18px;
        font-style: italic;
        font-family: 'Courier New';
    }
    p {
        text-align: center;
        font-size: 30px;
        color: dimgray;
        font-family: 'Courier New';
    }
    ul {
        text-align: center;
        font-size: 25px;
        color: black;
        font-style: italic;
    }
    table {
        padding: 5px;
        font-family: 'Courier New';
    }
    body {
        background-image: url(./image/website_background.jpg);
    }
</style>


</body>
</html>